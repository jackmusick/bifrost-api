# Feature Specification: Dynamic Data Provider Inputs for Forms

**Feature Branch**: `007-in-our-applications`
**Created**: 2025-10-22
**Status**: Draft
**Input**: User description: "In our applications, our forms can accept Data Providers as sources for input. This allows them to dynamically generate drop down items through automation. I'd like to be able to add input to our data providers in the same way that we do workflows. When a data provider is selected on a form, you would get see options for the avaialble inputs. You could either fill them in manually or select inputs from a dropdown generated by the form's context. This context could just be selecting the input value from another field (say a text box), or it could be using JavaScript just like in our Visibility Expression, which allows us to say something like: context.field.field_name, or context.workflow.some_prop. The end result is that forms can accept input from other items on the form. One use-case would be if you were trying to run a workflow that was going to setup GitHub sync. You may need to enter your GitHub PAT, then a dropdown for get_github_repos would require that token. Since the get_github_repos dropdown has a required field, you would essentially disable that field until a value was entered, then refresh the data provider. We would not want to refresh any of these data providers until the required field was met AND THE USER LEFT FOCUS ON AN INPUT. This is to avoid refreshing while typing, which could make multiple failed calls. Success looks like being able to specify inputs on data providers just like workflows, and  have the form react appropriately and as described to those requirements."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Configure Data Provider with Static Input Values (Priority: P1)

A form administrator needs to configure a dropdown that calls a data provider with predefined input values (e.g., a "Get GitHub Repositories" dropdown that requires a specific organization name).

**Why this priority**: This is the foundational capability - being able to define and manually configure inputs for data providers. Without this, none of the dynamic features matter. This delivers immediate value by enabling data providers that require parameters, even if those parameters are static.

**Independent Test**: Can be fully tested by creating a form with a dropdown field, configuring it to use a data provider that requires inputs, manually entering static values for those inputs in the form builder, and verifying the dropdown populates correctly when the form loads.

**Acceptance Scenarios**:

1. **Given** a form with a dropdown field configured to use a data provider that has required inputs, **When** the form administrator provides static values for all required inputs in the form builder, **Then** the dropdown successfully loads and displays options from the data provider when the form is rendered
2. **Given** a form with a dropdown field configured to use a data provider with optional inputs, **When** the form administrator provides values for some but not all optional inputs, **Then** the dropdown successfully loads with the provided inputs while using defaults for omitted inputs
3. **Given** a form with a dropdown field configured to use a data provider with required inputs, **When** the form administrator attempts to save the form without providing all required input values, **Then** the system prevents saving and displays a validation error indicating which required inputs are missing

---

### User Story 2 - Reference Other Form Fields as Data Provider Inputs (Priority: P2)

A form administrator needs to configure a dropdown where input values come from other fields on the same form (e.g., a "GitHub Repositories" dropdown that uses a GitHub token from a text field above it).

**Why this priority**: This enables basic inter-field dependencies and is the most common use case. It allows forms to be reactive without requiring complex expressions. This builds directly on P1 by adding dynamic field references instead of static values.

**Independent Test**: Can be fully tested by creating a form with two fields - a text input for a token and a dropdown that references that token field as an input parameter. Verify that changing the token field value and leaving focus triggers a refresh of the dropdown options.

**Acceptance Scenarios**:

1. **Given** a form with a text field for "GitHub Token" and a dropdown configured to use a data provider where the token input references the text field, **When** a user enters a valid token in the text field and leaves focus (blur event), **Then** the dropdown automatically refreshes and displays repositories accessible with that token
2. **Given** a form with a dropdown that has a required input referencing another field, **When** the referenced field is empty or invalid, **Then** the dropdown is disabled and displays a message indicating why it cannot load (e.g., "Requires GitHub Token")
3. **Given** a form with a dropdown that has optional inputs referencing other fields, **When** some referenced fields are empty, **Then** the dropdown remains enabled and loads options using only the provided input values
4. **Given** a dropdown that depends on another field, **When** the user is actively typing in the referenced field, **Then** the dropdown does not refresh until the user leaves focus from the input field (to prevent excessive API calls)

---

### User Story 3 - Use JavaScript Expressions for Data Provider Inputs (Priority: P3)

A form administrator needs to configure a dropdown where input values are derived from JavaScript expressions that can access form context (e.g., `context.field.token_field` or transformations like `context.field.org_name.toLowerCase()`).

**Why this priority**: This provides maximum flexibility for advanced use cases, such as combining multiple field values, applying transformations, or accessing workflow properties. It builds on P2 by allowing computed values rather than direct field references.

**Independent Test**: Can be fully tested by creating a form with multiple fields and a dropdown configured with JavaScript expression inputs (e.g., concatenating two text fields or transforming a value). Verify that the expression evaluates correctly and the dropdown refreshes with the computed input values.

**Acceptance Scenarios**:

1. **Given** a form with multiple text fields and a dropdown configured to use a data provider where an input uses a JavaScript expression like `context.field.first_name + ' ' + context.field.last_name`, **When** both text fields have values and the user leaves focus, **Then** the dropdown refreshes using the concatenated value as input
2. **Given** a dropdown configured with a JavaScript expression input, **When** the expression evaluates to an invalid value (null, undefined, or wrong type), **Then** the dropdown treats the input as missing and behaves according to whether the input is required or optional
3. **Given** a dropdown with a JavaScript expression that accesses `context.workflow.some_property`, **When** the form is used in a workflow context, **Then** the expression can successfully access workflow properties as inputs to the data provider
4. **Given** a dropdown with a JavaScript expression that throws a runtime error, **When** the expression is evaluated, **Then** the system logs the error and displays a user-friendly message without breaking the form

---

### User Story 4 - Form Builder UI for Input Configuration (Priority: P2)

A form administrator needs a user interface in the form builder to configure data provider inputs without writing code or JSON manually.

**Why this priority**: While technically this could be done by manually editing form JSON, a UI is essential for usability and adoption. This is P2 because it can be built in parallel with or immediately after P1, and delivers a complete user experience for the static input scenario.

**Independent Test**: Can be fully tested by opening the form builder, selecting a data provider for a dropdown field, and verifying that a UI appears showing all available inputs with options to enter static values, select field references, or write JavaScript expressions.

**Acceptance Scenarios**:

1. **Given** a form builder interface with a dropdown field configured to use a data provider, **When** the data provider has defined input parameters, **Then** the form builder displays a configuration panel showing each input parameter with its label, type, and whether it's required
2. **Given** the input configuration panel for a data provider, **When** configuring an input parameter, **Then** the form builder offers a choice between three modes: "Static Value" (manual entry), "Field Reference" (dropdown of available form fields), and "JavaScript Expression" (code editor)
3. **Given** an input configured as "Field Reference", **When** selecting from the field dropdown, **Then** only fields that appear earlier in the form field order are available (to prevent circular dependencies)
4. **Given** an input configured as "JavaScript Expression", **When** typing in the expression editor, **Then** the editor provides autocomplete suggestions for `context.field.*` and `context.workflow.*` properties

---

### Edge Cases

- What happens when a circular dependency is created (Field A's dropdown depends on Field B, and Field B's dropdown depends on Field A)?
  - System should detect circular dependencies during form validation and prevent the form from being saved with a clear error message

- How does the system handle a data provider that takes a long time to respond (e.g., 10+ seconds)?
  - The dropdown should display a loading indicator and remain in loading state until the data provider responds or times out (standard timeout applies)
  - If the data provider times out, display an error message and allow the user to retry manually

- What happens when a referenced field is deleted from the form?
  - Any dropdowns using that field as an input should show a validation error in the form builder
  - The form should not allow saving until the broken reference is fixed or removed

- How does the system handle data providers that return errors when called with invalid inputs?
  - Display the error message in the dropdown's UI (e.g., "Invalid token" or "API rate limit exceeded")
  - Log the error for debugging purposes
  - Allow the user to correct the input and retry

- What happens when a user rapidly changes a field value multiple times before leaving focus?
  - Only the final blur event triggers a refresh, ensuring only one API call is made per editing session

- How does the system handle forms that use data provider inputs in a workflow execution context versus a standalone form?
  - When a form is rendered in a workflow context, `context.workflow.*` expressions should work
  - When a form is rendered standalone, `context.workflow.*` expressions should evaluate to undefined/null and be handled according to whether the input is required

- What happens when a data provider input is configured with both a static value AND a field reference?
  - The system should enforce only one input mode at a time during configuration
  - If somehow both exist, field reference/expression should take precedence over static value

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Data providers MUST support the same parameter definition mechanism as workflows, allowing declaration of input parameters with names, types, labels, required/optional flags, and validation rules

- **FR-002**: System MUST allow form administrators to configure data provider inputs using three modes: static values (manually entered), field references (selecting another form field), or JavaScript expressions (code with access to form context)

- **FR-003**: When a dropdown field uses a data provider with required inputs, the dropdown MUST remain disabled until all required inputs have valid values

- **FR-004**: System MUST refresh data provider options only on blur events (when user leaves focus from a referenced input field), not on every keystroke, to prevent excessive API calls during typing

- **FR-005**: Field references in data provider inputs MUST only allow selection of fields that appear earlier in the form's field order to prevent circular dependencies

- **FR-006**: System MUST validate form configurations to detect and prevent circular dependencies where Field A depends on Field B and Field B depends on Field A (directly or indirectly)

- **FR-007**: JavaScript expressions for data provider inputs MUST have access to form context via `context.field.*` to reference other field values and `context.workflow.*` to reference workflow properties when applicable

- **FR-008**: System MUST provide clear visual feedback for dropdown states: loading (spinner/indicator), disabled (with reason), error (with message), and ready (populated options)

- **FR-009**: When a data provider is called with inputs and returns an error, the system MUST display the error message to the user and allow them to correct inputs and retry

- **FR-010**: Form builder MUST provide a UI for configuring data provider inputs without requiring manual JSON editing, showing all available inputs with their metadata (label, type, required status)

- **FR-011**: When a referenced field is deleted from a form, the system MUST detect broken references in data provider configurations and prevent the form from being saved until resolved

- **FR-012**: Data provider input configuration MUST support optional parameters with default values, allowing dropdowns to function even when some inputs are not provided

- **FR-013**: System MUST cache data provider results based on the input parameter values to avoid redundant API calls when the same inputs are used multiple times

- **FR-014**: When a JavaScript expression throws a runtime error during evaluation, the system MUST handle it gracefully by logging the error and displaying a user-friendly message without breaking the form

- **FR-015**: System MUST support data providers with no inputs (current behavior), one input, or multiple inputs

### Key Entities

- **Data Provider Input Configuration**: Represents how an input parameter for a data provider is configured on a form field. Contains the input parameter name, the configuration mode (static/field reference/JavaScript expression), and the value/reference/expression itself.

- **Data Provider Parameter Metadata**: Describes an input parameter that a data provider accepts. Includes parameter name, type, label, whether it's required, default value, and validation rules. This is parallel to workflow parameters.

- **Form Field Context**: The runtime context available to JavaScript expressions when evaluating data provider inputs. Includes references to other form field values (`context.field.*`) and workflow properties when applicable (`context.workflow.*`).

- **Data Provider Cache Entry**: A cached set of options returned by a data provider for a specific combination of input parameter values. Includes the options data, cache expiration timestamp, and a cache key derived from provider name and input values.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Form administrators can configure dropdowns with data providers requiring inputs in under 2 minutes without consulting documentation

- **SC-002**: Forms with conditional dropdowns (dependent on other fields) respond to input changes within 500ms of the user leaving focus from the referenced field

- **SC-003**: The system prevents 100% of circular dependency configurations from being saved through validation

- **SC-004**: Users can successfully configure inter-dependent form fields (e.g., token + repositories dropdown) on their first attempt with 90% success rate

- **SC-005**: Data provider API calls are reduced by at least 80% compared to a hypothetical on-keystroke implementation through the use of blur-based refresh

- **SC-006**: 95% of data provider errors (invalid inputs, API failures) are displayed to users with actionable error messages rather than silent failures

- **SC-007**: Form administrators report satisfaction with the input configuration UI, with 85% finding it intuitive without training

## Assumptions

- Data providers follow the same decorator pattern as workflows (`@param` decorator) for defining input parameters
- The existing form rendering engine can be extended to handle disabled states and dynamic refresh logic
- The existing visibility expression evaluation mechanism can be reused or adapted for data provider input expressions
- Form context (`context.field.*`, `context.workflow.*`) already exists in some form for visibility expressions and can be leveraged
- Data provider caching infrastructure exists and can be keyed on input parameter values
- The form builder UI framework supports dynamic form controls and field dependency tracking
- Data providers are already designed to be stateless and can accept input parameters via their function signatures
