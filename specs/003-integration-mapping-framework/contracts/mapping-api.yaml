openapi: 3.0.3
info:
  title: Integration Mapping API
  description: API for managing organization integration mappings
  version: 1.0.0
  contact:
    name: MSP Automation Platform

servers:
  - url: https://api.example.com/api
    description: Production API
  - url: http://localhost:7071/api
    description: Local development

paths:
  /organizations/{orgId}/integrations:
    get:
      summary: List integration mappings for organization
      description: Returns all integration mappings for the specified organization
      operationId: listOrgIntegrationMappings
      tags:
        - Integration Mappings
      parameters:
        - name: orgId
          in: path
          required: true
          description: Organization ID (UUID)
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: activeOnly
          in: query
          required: false
          description: Filter to only active mappings
          schema:
            type: boolean
            default: true
          example: true
      responses:
        '200':
          description: List of integration mappings
          content:
            application/json:
              schema:
                type: object
                properties:
                  mappings:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrganizationMapping'
                  count:
                    type: integer
                    example: 3
              examples:
                withMappings:
                  value:
                    mappings:
                      - id: "abc-123"
                        org_id: "550e8400-e29b-41d4-a716-446655440000"
                        integration_name: "halopsa"
                        external_org_id: "12345"
                        external_org_name: "Acme Corp"
                        mapping_data:
                          api_base_url: "https://acme.halopsa.com"
                        is_active: true
                        created_at: "2025-10-11T10:30:00Z"
                        created_by: "user-uuid-123"
                        updated_at: "2025-10-11T10:30:00Z"
                        last_tested_at: "2025-10-11T10:31:00Z"
                        last_test_result: "Successfully connected"
                      - id: "def-456"
                        org_id: "550e8400-e29b-41d4-a716-446655440000"
                        integration_name: "microsoft_graph"
                        external_org_id: "72f988bf-86f1-41af-91ab-2d7cd011db47"
                        external_org_name: "Contoso Corporation"
                        mapping_data: {}
                        is_active: true
                        created_at: "2025-10-11T11:00:00Z"
                        created_by: "user-uuid-123"
                        updated_at: "2025-10-11T11:00:00Z"
                    count: 2
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      summary: Create integration mapping
      description: Creates a new integration mapping for the organization
      operationId: createIntegrationMapping
      tags:
        - Integration Mappings
      parameters:
        - name: orgId
          in: path
          required: true
          description: Organization ID (UUID)
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMappingRequest'
            examples:
              halopsa:
                summary: HaloPSA mapping
                value:
                  integration_name: "halopsa"
                  external_org_id: "12345"
                  external_org_name: "Acme Corp"
                  mapping_data:
                    api_base_url: "https://acme.halopsa.com"
                    default_agent_id: "789"
              microsoft_graph:
                summary: Microsoft Graph mapping
                value:
                  integration_name: "microsoft_graph"
                  external_org_id: "72f988bf-86f1-41af-91ab-2d7cd011db47"
                  external_org_name: "Contoso Corporation"
                  mapping_data: {}
      responses:
        '201':
          description: Mapping created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationMapping'
              example:
                id: "abc-123"
                org_id: "550e8400-e29b-41d4-a716-446655440000"
                integration_name: "halopsa"
                external_org_id: "12345"
                external_org_name: "Acme Corp"
                mapping_data:
                  api_base_url: "https://acme.halopsa.com"
                is_active: true
                created_at: "2025-10-11T10:30:00Z"
                created_by: "user-uuid-123"
                updated_at: "2025-10-11T10:30:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /organizations/{orgId}/integrations/{mappingId}:
    get:
      summary: Get integration mapping
      description: Retrieves a specific integration mapping by ID
      operationId: getIntegrationMapping
      tags:
        - Integration Mappings
      parameters:
        - $ref: '#/components/parameters/orgId'
        - name: mappingId
          in: path
          required: true
          description: Mapping ID (RowKey format integration_name_uuid)
          schema:
            type: string
          example: "halopsa_abc-123"
      responses:
        '200':
          description: Integration mapping
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationMapping'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update integration mapping
      description: Updates an existing integration mapping
      operationId: updateIntegrationMapping
      tags:
        - Integration Mappings
      parameters:
        - $ref: '#/components/parameters/orgId'
        - name: mappingId
          in: path
          required: true
          schema:
            type: string
          example: "halopsa_abc-123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMappingRequest'
            example:
              external_org_name: "Acme Corporation"
              mapping_data:
                api_base_url: "https://acme-new.halopsa.com"
                default_agent_id: "999"
      responses:
        '200':
          description: Mapping updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationMapping'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete integration mapping
      description: Soft deletes an integration mapping (sets is_active=false)
      operationId: deleteIntegrationMapping
      tags:
        - Integration Mappings
      parameters:
        - $ref: '#/components/parameters/orgId'
        - name: mappingId
          in: path
          required: true
          schema:
            type: string
          example: "halopsa_abc-123"
      responses:
        '204':
          description: Mapping deleted successfully
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /organizations/{orgId}/integrations/{mappingId}/test:
    post:
      summary: Test integration mapping
      description: Tests the connection for an integration mapping
      operationId: testIntegrationMapping
      tags:
        - Integration Mappings
      parameters:
        - $ref: '#/components/parameters/orgId'
        - name: mappingId
          in: path
          required: true
          schema:
            type: string
          example: "halopsa_abc-123"
      responses:
        '200':
          description: Test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestResult'
              examples:
                success:
                  summary: Successful connection
                  value:
                    success: true
                    message: "Successfully connected to Acme Corp (ID: 12345)"
                    details:
                      client_name: "Acme Corp"
                      api_version: "1.0"
                failure:
                  summary: Failed connection
                  value:
                    success: false
                    message: "Authentication failed: Invalid API key"
                    details:
                      error_code: "AUTH_001"
                      http_status: 401
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /integrations/{integrationName}/discover:
    get:
      summary: Discover external organizations
      description: Fetches available organizations from integration for mapping
      operationId: discoverExternalOrganizations
      tags:
        - Organization Discovery
      parameters:
        - name: integrationName
          in: path
          required: true
          description: Integration identifier (e.g., halopsa, microsoft_graph)
          schema:
            type: string
          example: "halopsa"
        - name: orgId
          in: query
          required: true
          description: Organization ID (for credentials lookup)
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: refresh
          in: query
          required: false
          description: Force refresh (bypass cache)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of external organizations
          content:
            application/json:
              schema:
                type: object
                properties:
                  organizations:
                    type: array
                    items:
                      $ref: '#/components/schemas/ExternalOrganization'
                  cached_at:
                    type: string
                    format: date-time
                    description: Timestamp when data was cached
                  cache_expires_at:
                    type: string
                    format: date-time
                    description: Timestamp when cache expires
              example:
                organizations:
                  - id: "12345"
                    name: "Acme Corp"
                    metadata:
                      client_code: "ACME001"
                      is_vip: true
                  - id: "67890"
                    name: "Wayne Enterprises"
                    metadata:
                      client_code: "WAYNE001"
                      is_vip: false
                cached_at: "2025-10-11T10:00:00Z"
                cache_expires_at: "2025-10-11T11:00:00Z"
        '400':
          description: Integration doesn't support discovery
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Integration doesn't support organization discovery"
                message: "Integration 'custom_integration' does not implement list_organizations()"
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Integration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Integration not found"
                message: "Integration 'invalid_integration' not registered"

components:
  parameters:
    orgId:
      name: orgId
      in: path
      required: true
      description: Organization ID (UUID)
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

  schemas:
    OrganizationMapping:
      type: object
      required:
        - id
        - org_id
        - integration_name
        - external_org_id
        - is_active
        - created_at
        - created_by
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique mapping ID
          example: "abc-123"
        org_id:
          type: string
          format: uuid
          description: MSP organization ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        integration_name:
          type: string
          pattern: '^[a-z_]+$'
          description: Integration identifier
          example: "halopsa"
        external_org_id:
          type: string
          minLength: 1
          maxLength: 200
          description: External organization ID in integration system
          example: "12345"
        external_org_name:
          type: string
          maxLength: 200
          description: Human-readable external org name
          example: "Acme Corp"
        mapping_data:
          type: object
          description: Integration-specific configuration (JSON)
          additionalProperties: true
          example:
            api_base_url: "https://acme.halopsa.com"
            default_agent_id: "789"
        is_active:
          type: boolean
          description: Mapping active status
          example: true
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2025-10-11T10:30:00Z"
        created_by:
          type: string
          description: User ID who created mapping
          example: "user-uuid-123"
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-10-11T10:30:00Z"
        updated_by:
          type: string
          nullable: true
          description: User ID who last updated mapping
          example: null
        last_tested_at:
          type: string
          format: date-time
          nullable: true
          description: Last test timestamp
          example: "2025-10-11T10:31:00Z"
        last_test_result:
          type: string
          nullable: true
          description: Result of last connection test
          example: "Successfully connected"

    CreateMappingRequest:
      type: object
      required:
        - integration_name
        - external_org_id
      properties:
        integration_name:
          type: string
          pattern: '^[a-z_]+$'
          description: Integration identifier
          example: "halopsa"
        external_org_id:
          type: string
          minLength: 1
          maxLength: 200
          description: External organization ID
          example: "12345"
        external_org_name:
          type: string
          maxLength: 200
          description: External organization name (optional)
          example: "Acme Corp"
        mapping_data:
          type: object
          description: Integration-specific configuration
          additionalProperties: true
          default: {}
          example:
            api_base_url: "https://acme.halopsa.com"

    UpdateMappingRequest:
      type: object
      properties:
        external_org_id:
          type: string
          minLength: 1
          maxLength: 200
          description: Updated external org ID
          example: "12345-updated"
        external_org_name:
          type: string
          maxLength: 200
          description: Updated external org name
          example: "Acme Corporation"
        mapping_data:
          type: object
          description: Updated integration-specific configuration
          additionalProperties: true
          example:
            api_base_url: "https://acme-new.halopsa.com"
        is_active:
          type: boolean
          description: Updated active status
          example: true

    ExternalOrganization:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: External organization ID
          example: "12345"
        name:
          type: string
          description: Organization display name
          example: "Acme Corp"
        metadata:
          type: object
          description: Integration-specific metadata
          additionalProperties: true
          example:
            client_code: "ACME001"
            is_vip: true

    TestResult:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: Test succeeded
          example: true
        message:
          type: string
          description: Human-readable result message
          example: "Successfully connected to Acme Corp"
        details:
          type: object
          description: Additional diagnostic information
          additionalProperties: true
          example:
            client_name: "Acme Corp"
            api_version: "1.0"

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type
          example: "Validation failed"
        message:
          type: string
          description: Human-readable error message
          example: "External org ID is required"
        details:
          type: object
          description: Validation errors or additional context
          additionalProperties: true
          example:
            external_org_id:
              - "This field is required"

  responses:
    BadRequest:
      description: Bad request - validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Validation failed"
            message: "Invalid request body"
            details:
              external_org_id:
                - "This field is required"

    Forbidden:
      description: Forbidden - insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Forbidden"
            message: "canManageConfig permission required"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Not found"
            message: "Mapping with ID 'halopsa_abc-123' not found"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Azure AD JWT token

security:
  - BearerAuth: []
