# Bifrost Docker Stack - Full Development Environment
#
# Usage:
#   docker compose up              # Start all services with hot reload
#   docker compose up -d           # Start in background
#   docker compose logs -f api     # Follow API logs
#
# Debugging with VS Code:
#   ENABLE_DEBUG=true docker compose up
#   Then attach VS Code debugger to port 5678 (API waits for debugger)
#
# Required environment variables for production:
#   BIFROST_SECRET_KEY  - 32+ char secret for JWT signing and secret encryption
#   POSTGRES_PASSWORD   - PostgreSQL password
#   RABBITMQ_PASSWORD   - RabbitMQ password
#
# The BIFROST_SECRET_KEY is critical - it's used for:
#   - JWT token signing (HS256)
#   - Fernet encryption of secrets stored in PostgreSQL
#   - Must be consistent across API and Jobs workers
#   - Changing it will invalidate all existing tokens and secrets

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: bifrost-postgres
    environment:
      POSTGRES_DB: bifrost
      POSTGRES_USER: bifrost
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bifrost_dev}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bifrost -d bifrost"]
      interval: 5s
      timeout: 5s
      retries: 5

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: bifrost-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: bifrost
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-bifrost_dev}
    ports:
      - "5672:5672"    # AMQP
      - "15672:15672"  # Management UI (for debugging only)
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Redis (Sessions & Cache)
  redis:
    image: redis:7-alpine
    container_name: bifrost-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # FastAPI Application
  api:
    build:
      context: .
      dockerfile: api/Dockerfile.dev
    container_name: bifrost-api
    environment:
      # Core
      BIFROST_ENVIRONMENT: ${BIFROST_ENVIRONMENT:-development}
      BIFROST_DEBUG: ${BIFROST_DEBUG:-false}
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      # Database
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@postgres:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@postgres:5432/bifrost
      # Message Queue & Cache
      BIFROST_RABBITMQ_URL: amqp://bifrost:${RABBITMQ_PASSWORD:-bifrost_dev}@rabbitmq:5672/
      BIFROST_REDIS_URL: redis://redis:6379/0
      # File Storage
      BIFROST_WORKSPACE_LOCATION: /workspace
      # CORS & Frontend
      BIFROST_CORS_ORIGINS: ${BIFROST_CORS_ORIGINS:-http://localhost:3000}
      BIFROST_FRONTEND_URL: ${BIFROST_FRONTEND_URL:-http://localhost:3000}
      # JWT (optional, has defaults)
      BIFROST_ACCESS_TOKEN_EXPIRE_MINUTES: ${BIFROST_ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      BIFROST_REFRESH_TOKEN_EXPIRE_DAYS: ${BIFROST_REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # MFA (optional, has defaults)
      BIFROST_MFA_ENABLED: ${BIFROST_MFA_ENABLED:-true}
      BIFROST_MFA_TOTP_ISSUER: ${BIFROST_MFA_TOTP_ISSUER:-Bifrost}
      # Default admin user (optional - set in .env to skip setup wizard)
      BIFROST_DEFAULT_USER_EMAIL: ${BIFROST_DEFAULT_USER_EMAIL:-}
      BIFROST_DEFAULT_USER_PASSWORD: ${BIFROST_DEFAULT_USER_PASSWORD:-}
      # OAuth SSO (optional - set in .env to enable)
      BIFROST_MICROSOFT_CLIENT_ID: ${BIFROST_MICROSOFT_CLIENT_ID:-}
      BIFROST_MICROSOFT_CLIENT_SECRET: ${BIFROST_MICROSOFT_CLIENT_SECRET:-}
      BIFROST_MICROSOFT_TENANT_ID: ${BIFROST_MICROSOFT_TENANT_ID:-}
      BIFROST_GOOGLE_CLIENT_ID: ${BIFROST_GOOGLE_CLIENT_ID:-}
      BIFROST_GOOGLE_CLIENT_SECRET: ${BIFROST_GOOGLE_CLIENT_SECRET:-}
      BIFROST_OIDC_DISCOVERY_URL: ${BIFROST_OIDC_DISCOVERY_URL:-}
      BIFROST_OIDC_CLIENT_ID: ${BIFROST_OIDC_CLIENT_ID:-}
      BIFROST_OIDC_CLIENT_SECRET: ${BIFROST_OIDC_CLIENT_SECRET:-}
      # Debugging (optional - enables debugpy)
      ENABLE_DEBUG: ${ENABLE_DEBUG:-false}
    ports:
      - "5678:5678"  # debugpy port for VS Code attachment
    # Note: API port 8000 not exposed - access via client proxy at http://localhost:3000
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
      - ./api/alembic:/app/alembic:ro
      - ./api/alembic.ini:/app/alembic.ini:ro
      - bifrost_workspace:/workspace
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: >
      sh -c "alembic upgrade head &&
             if [ \"$$ENABLE_DEBUG\" = \"true\" ]; then
               echo 'Starting with debugpy - waiting for VS Code to attach on port 5678...' &&
               python -m debugpy --listen 0.0.0.0:5678 --wait-for-client -m uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/src --reload-dir /app/shared;
             else
               uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/src --reload-dir /app/shared;
             fi"

  # Frontend (Vite)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: bifrost-client
    environment:
      API_URL: http://api:8000
      WS_URL: ws://api:8000
    ports:
      - "3000:3000"
    volumes:
      - ./client/src:/app/src
      - ./client/public:/app/public
      - ./client/index.html:/app/index.html
      - ./client/vite.config.ts:/app/vite.config.ts
    depends_on:
      api:
        condition: service_healthy

  # Discovery Service (File Watcher + DB Sync)
  # MUST run as single instance - owns file watching and DB sync exclusively
  discovery:
    build:
      context: .
      dockerfile: api/Dockerfile.dev
    container_name: bifrost-discovery
    environment:
      # Core (must match API)
      BIFROST_ENVIRONMENT: ${BIFROST_ENVIRONMENT:-development}
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      # Database
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@postgres:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@postgres:5432/bifrost
      # File Storage (read-only - only watches for changes)
      BIFROST_WORKSPACE_LOCATION: /workspace
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
      - bifrost_workspace:/workspace:ro  # Read-only for discovery
    depends_on:
      postgres:
        condition: service_healthy
      api:
        condition: service_healthy
    deploy:
      replicas: 1  # MUST be single instance
    command: >
      watchmedo auto-restart --directory=/app/src --directory=/app/shared --pattern="*.py" --recursive -- python -m src.discovery.main

  # Scheduler Service (APScheduler only)
  # MUST run as single instance - handles CRON jobs, cleanup tasks, OAuth refresh
  scheduler:
    build:
      context: .
      dockerfile: api/Dockerfile.dev
    container_name: bifrost-scheduler
    environment:
      # Core (must match API)
      BIFROST_ENVIRONMENT: ${BIFROST_ENVIRONMENT:-development}
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      # Database
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@postgres:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@postgres:5432/bifrost
      # Message Queue
      BIFROST_RABBITMQ_URL: amqp://bifrost:${RABBITMQ_PASSWORD:-bifrost_dev}@rabbitmq:5672/
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
      # No workspace mount - scheduler only runs scheduled jobs
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      api:
        condition: service_healthy
      discovery:
        condition: service_started
    deploy:
      replicas: 1  # MUST be single instance
    command: >
      watchmedo auto-restart --directory=/app/src --directory=/app/shared --pattern="*.py" --recursive -- python -m src.scheduler.main

  # Worker Service (RabbitMQ Consumers)
  # Can be scaled horizontally for increased throughput
  worker:
    build:
      context: .
      dockerfile: api/Dockerfile.dev
    container_name: bifrost-worker
    environment:
      # Core (must match API)
      BIFROST_ENVIRONMENT: ${BIFROST_ENVIRONMENT:-development}
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      # Database
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@postgres:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@postgres:5432/bifrost
      # Message Queue & Cache
      BIFROST_RABBITMQ_URL: amqp://bifrost:${RABBITMQ_PASSWORD:-bifrost_dev}@rabbitmq:5672/
      BIFROST_REDIS_URL: redis://redis:6379/0
      # File Storage (read-write for git sync)
      BIFROST_WORKSPACE_LOCATION: /workspace
      # Concurrency
      BIFROST_MAX_CONCURRENCY: ${BIFROST_MAX_CONCURRENCY:-10}
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
      - bifrost_workspace:/workspace
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      api:
        condition: service_healthy
      discovery:
        condition: service_started
    deploy:
      replicas: ${WORKER_REPLICAS:-1}
    command: >
      watchmedo auto-restart --directory=/app/src --directory=/app/shared --pattern="*.py" --recursive -- python -m src.worker.main

volumes:
  postgres_data:
  rabbitmq_data:
  redis_data:
  bifrost_workspace:
