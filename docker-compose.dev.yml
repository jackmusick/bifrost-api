# Development overrides for docker-compose.yml
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# This file adds development-specific configuration:
# - Hot reload with volume mounts for live code changes
# - Development-specific Dockerfiles (dependencies only)
# - Watch mode for services

services:
  # API with hot reload for development
  api:
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
      - ./api/alembic:/app/alembic:ro
      - ./api/alembic.ini:/app/alembic.ini:ro
    command: >
      sh -c "alembic upgrade head &&
             if [ \"$$ENABLE_DEBUG\" = \"true\" ]; then
               echo 'Starting with debugpy - waiting for VS Code to attach on port 5678...' &&
               python -m debugpy --listen 0.0.0.0:5678 --wait-for-client -m uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/src --reload-dir /app/shared;
             else
               uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/src --reload-dir /app/shared;
             fi"

  # Discovery with hot reload for development
  discovery:
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro

  # Scheduler with hot reload for development
  scheduler:
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro

  # Worker with hot reload for development
  worker:
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro

  # Client with hot reload for development
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
      target: ""  # Clear the production target from base compose file
    volumes:
      - ./client/src:/app/src
      - ./client/public:/app/public
      - ./client/index.html:/app/index.html
      - ./client/vite.config.ts:/app/vite.config.ts
      - ./client/tsconfig.json:/app/tsconfig.json
      - ./client/tsconfig.app.json:/app/tsconfig.app.json
      - ./client/tsconfig.node.json:/app/tsconfig.node.json
      - ./client/tailwind.config.ts:/app/tailwind.config.ts
      - ./client/postcss.config.js:/app/postcss.config.js
